<!DOCTYPE html>
<html lang="en" ng-app="revenueApp" ng-controller="RevenueController">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Revenue and Room Count Charts</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        .chart-container {
            width: 100%;
            display: inline-block;
            vertical-align: top;
            margin: 40px;
           /*  margin-left:100px; */
        }
        canvas {
            max-width: 100%;
            height: 500px;
            
        }
    </style>
</head>
<body>
  <div th:replace="/layout/menudoc :: html"></div>
    <div class="container">
        <h1 class="text-center">Revenue and Room Count Charts</h1>
        <div class="row" style="margin-left:100px">
            <div class="col-md-6">
                <h3>Revenue Chart</h3>
                <select ng-model="selectedYearRevenue" ng-change="getRevenueData(selectedYearRevenue)" ng-options="year for year in years"></select>
                <div class="chart-container">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <h3>Room Count Chart</h3>
                <select ng-model="selectedYearRoomCount" ng-change="getRoomCountData(selectedYearRoomCount)" ng-options="year for year in years"></select>
                <div class="chart-container">
                    <canvas id="roomCountChart"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <h3>Room Pie Chart</h3>
               
                <div class="chart-container">
                     <canvas id="roomTypeChart" ></canvas>
                </div>
            </div>
            
        </div>
        <div>
   <!-- Dropdown cho chọn năm -->
<select ng-model="selectedYear" ng-change="getTopUsersData(selectedYear, selectedMonth)" ng-options="year for year in years">
    <option value="">Chọn năm</option>
</select>

<!-- Dropdown cho chọn tháng -->
<select ng-model="selectedMonth" ng-change="getTopUsersData(selectedYear, selectedMonth)" ng-options="month for month in months">
    <option value="">Chọn tháng</option>
</select>

<!-- Hiển thị thống kê người đặt phòng nhiều nhất -->
<h3>Thống kê người đặt phòng nhiều nhất theo tháng trong năm</h3>
<div ng-repeat="user in topUsers">
    <p>Email: {{ user.userEmail }} - Tháng: {{ user.month }} - Năm: {{ user.year }} - Số lượng đặt phòng: {{ user.bookingCount }}</p>
</div>



    </div>
    
    <!-- <h1>Room Type Distribution</h1>
    <table>
        <thead>
            <tr>
                <th>Room Type</th>
                <th>Count</th>
            </tr>
        </thead>
        <tbody>
            <tr ng-repeat="roomType in roomTypes">
                <td>{{ roomType.roomTypeName }}</td>
                <td>{{ roomType.count }}</td>
            </tr>
        </tbody>
    </table> -->
   
</div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.2/angular.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        var app = angular.module('revenueApp', []);
        app.controller('RevenueController', function($scope, $http) {
            $scope.years = Array.from({length: 12}, (_, i) => 2019 + i);

            var revenueChart = new Chart(document.getElementById('revenueChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Revenue',
                        data: [],
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            var roomCountChart = new Chart(document.getElementById('roomCountChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Room Count',
                        data: [],
                        backgroundColor: 'rgba(153, 102, 255, 0.2)',
                        borderColor: 'rgba(153, 102, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            $scope.getRevenueData = function(year) {
                $http.get('/api/revenue', { params: { year: year } })
                    .then(function(response) {
                        $scope.updateRevenueChart(response.data);
                    })
                    .catch(function(error) {
                        console.error("Error loading revenue data:", error);
                    });
            };

            $scope.updateRevenueChart = function(data) {
                var labels = data.map(item => item.month);
                var revenues = data.map(item => item.revenue);

                revenueChart.data.labels = labels;
                revenueChart.data.datasets[0].data = revenues;
                revenueChart.update();
            };

            $scope.getRoomCountData = function(year) {
                $http.get('/api/roomcount', { params: { year: year } })
                    .then(function(response) {
                        $scope.updateRoomCountChart(response.data);
                    })
                    .catch(function(error) {
                        console.error("Error loading room count data:", error);
                    });
            };

            $scope.updateRoomCountChart = function(data) {
                var labels = data.map(item => item.month);
                var roomCounts = data.map(item => item.roomCount);

                roomCountChart.data.labels = labels;
                roomCountChart.data.datasets[0].data = roomCounts;
                roomCountChart.update();
            };

            // Load initial data for the current year
            var currentYear = new Date().getFullYear();
            $scope.selectedYearRevenue = currentYear;
            $scope.selectedYearRoomCount = currentYear;
            $scope.getRevenueData(currentYear);
            $scope.getRoomCountData(currentYear);
            
            $scope.years = [2022, 2023, 2024, 2025];  // Thêm các năm bạn muốn
            $scope.months = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12];  // Các tháng từ 1 đến 12

            // Biến lưu trữ danh sách người dùng có số lượng đặt phòng nhiều nhất
            $scope.topUsers = [];

            // Hàm lấy dữ liệu người đặt phòng nhiều nhất theo năm và tháng
            $scope.getTopUsersData = function(year, month) {
                if (year && month) {
                    // Gọi API để lấy thống kê người đặt phòng
                    $http.get('/api/top-users/' + year + '/' + month).then(function(response) {
                        $scope.topUsers = response.data;
                    });
                }
            };
            
            $http.get('/api/counts')
            .then(function(response) {
                $scope.roomTypes = response.data;

                // Tạo dữ liệu cho biểu đồ
                var labels = [];
                var data = [];
                var backgroundColors = [];

                // Duyệt qua dữ liệu và chuẩn bị cho Chart.js
                $scope.roomTypes.forEach(function(roomType) {
                    labels.push(roomType.roomTypeName);
                    data.push(roomType.count);
                    // Màu sắc ngẫu nhiên cho từng phần trong biểu đồ
                    backgroundColors.push('rgba(' + Math.floor(Math.random() * 255) + ',' + 
                                           Math.floor(Math.random() * 255) + ',' + 
                                           Math.floor(Math.random() * 255) + ', 0.6)');
                });

                // Vẽ biểu đồ tròn
                var ctx = document.getElementById('roomTypeChart').getContext('2d');
                new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Room Type Distribution',
                            data: data,
                            backgroundColor: backgroundColors,
                            borderColor: 'rgba(255, 255, 255, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                enabled: true
                            }
                        }
                    }
                });
            }, function(error) {
                console.error('Error fetching room type counts:', error);
            });
        });
    </script>
</body>
</html>
