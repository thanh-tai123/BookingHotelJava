<!DOCTYPE html>
<html lang="en" ng-app="revenueApp" ng-controller="StatisticsController">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doanh thu theo Chi nhánh</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.2/angular.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Thêm CSS nếu cần thiết */
    </style>
</head>
<body>
<div th:replace="~{layout/menudoc :: html}"></div>
    <div class="container mt-5">
        <h2>Doanh thu theo Chi nhánh</h2>
        <div class="form-group">
            <label for="year">Chọn Năm:</label>
            <input type="number" id="year" ng-model="year" ng-change="getRevenueData(year)" min="1900" max="2100" class="form-control" required />
        </div>
        <canvas id="roomCountChart" width="400" height="200"></canvas>
    </div>

    <script>
        var app = angular.module('revenueApp', []);

        app.service('RevenueService', ['$http', function($http) {
            this.getRevenueByYear = function(year) {
                return $http.get(`/api/branch/${year}`);
            };
        }]);

        app.controller('StatisticsController', ['$scope', 'RevenueService', function($scope, RevenueService) {
            $scope.year = new Date().getFullYear(); // Năm hiện tại
            let roomCountChart;

            // Khởi tạo biểu đồ
            function initRoomCountChart() {
                const ctx = document.getElementById('roomCountChart').getContext('2d');
                roomCountChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Doanh thu',
                            data: [],
                            backgroundColor: 'rgba(153, 102, 255, 0.2)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            // Cập nhật biểu đồ với dữ liệu mới
            $scope.updateRevenueChart = function(data) {
                const labels = [];
                const revenues = [];

                data.forEach(item => {
                    labels.push(item.branch); // Dữ liệu chi nhánh
                    revenues.push(item.revenue); // Dữ liệu doanh thu
                });

                roomCountChart.data.labels = labels;
                roomCountChart.data.datasets[0].data = revenues;
                roomCountChart.update(); // Cập nhật biểu đồ
            };

            // Lấy dữ liệu doanh thu từ API
            $scope.getRevenueData = function(year) {
                if (isNaN(year) || year < 1900 || year > 2100) {
                    alert("Vui lòng nhập một năm hợp lệ.");
                    return;
                }

                RevenueService.getRevenueByYear(year)
                    .then(function(response) {
                        $scope.updateRevenueChart(response.data);
                    })
                    .catch(function(error) {
                        console.error("Lỗi khi tải dữ liệu doanh thu:", error);
                        alert("Không thể tải dữ liệu doanh thu.");
                    });
            };

            // Khởi tạo biểu đồ khi tải trang và lấy dữ liệu cho năm hiện tại
            initRoomCountChart();
            $scope.getRevenueData($scope.year);
        }]);
    </script>
</body>
</html>