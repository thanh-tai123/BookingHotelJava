<!DOCTYPE html>
<html lang="en" ng-app="app">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ĐẶT PHÒNG</title>
    <!-- Include jQuery -->

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Include AngularJS -->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>
    <link rel="icon" href="https://lavelasaigon.com/wp-content/uploads/2023/01/main-logo.png" type="image/png">
    <!-- Include Date Range Picker -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;

        }
        .room-details {
            display: flex;
            margin-bottom: 20px;
        }

        .room-image {
            height: 250px;
            width: 270px;
            margin-right: 15px;
            border-radius: 4px;
            margin-left: 20px;
            object-fit: cover;
        }

        .label {
            font-weight: bold;
        }
        .user-inputs {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 150px;
        }

        .user-input, .date-input {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            transition: border-color 0.3s;
        }

        .user-input:focus, .date-input:focus {
            border-color: #007bff;
            outline: none;
        }

        label {
            margin-bottom: 5px;
            font-weight: bold;
        }


        .user-inputs {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
            padding: 15px;
            background-color: #f1e8b8;
            border-radius: 8px;
        }

        .input-group {
            border-color: #f1e8b8;

            background-color:    #f1e8b8;
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 150px;
        }
        .number-input, .payment-select {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;

        }
        .book-button {
            background-color: #CDB38B;
            color: white;
            border-color: #c09b5a;;
            border-radius: 5px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            margin-top: 15px;
        }

        .book-button:hover {
            background-color: white;
            color: #c09b5a;
            border-color:#c09b5a;;

        }

        .book-button:active {
            background-color: #004080;
        }
        .booked-dates {
            list-style-type: none;
            padding: 0;
            margin: 20px 0;

        }

        .booked-dates li {
            background-color: #FFF5DE;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
            transition: background-color 0.3s ease;
            color: black;
        }

        .available-rooms {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        .room-item {
            margin-bottom: 20px; /* Khoảng cách giữa các hàng */
        }

        .room-box {
            display: flex; /* Sử dụng flexbox cho box */
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            background-color: #fff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.3s;
        }

        .room-box:hover {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            border:2px solid #c09b5a
                  }

        .room-image {
            width: 50%; /* Hình ảnh chiếm 50% chiều rộng của box */
            height: auto; /* Tự động điều chỉnh chiều cao */
            border-top-left-radius: 0.375rem;
            border-bottom-left-radius: 0.375rem;
        }

        .room-info {
            flex-grow: 1; /* Nội dung chiếm không gian còn lại */
            padding: 15px; /* Khoảng cách cho nội dung */
        }

        .checkbox {
            margin-top: auto; /* Đẩy checkbox xuống dưới cùng */
        }
.room-box {
    display: flex;
    align-items: center; /* Đặt tất cả các phần tử trong dòng giữa theo chiều dọc */
}

.room-info {
    display: flex;
    flex-wrap: wrap;
    align-items: center; /* Đặt tất cả phần tử thông tin trong dòng giữa */
    gap: 10px; /* Khoảng cách giữa các phần tử */
}

.room-info input.checkbox {
    margin-left: auto; /* Đẩy checkbox sang bên phải (nếu cần) */
}
 .checkbox {
            width: 20px; /* Điều chỉnh chiều rộng */
            height: 20px; /* Điều chỉnh chiều cao */
            transform: scale(1.5); /* Tăng kích thước bằng cách scale */
            cursor: pointer; /* Thay đổi con trỏ khi hover */
        }
        
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap');
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: "Poppins", sans-serif;
}
.chatbot-toggler {
  position: fixed;
  bottom: 30px;
  right: 35px;
  outline: none;
  border: none;
  height: 50px;
  width: 50px;
  display: flex;
  cursor: pointer;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  background: #e87e41;
  transition: all 0.2s ease;
}
body.show-chatbot .chatbot-toggler {
  transform: rotate(90deg);
}
.chatbot-toggler span {
  color: #fff;
  position: absolute;
}
.chatbot-toggler span:last-child,
body.show-chatbot .chatbot-toggler span:first-child  {
  opacity: 0;
}
body.show-chatbot .chatbot-toggler span:last-child {
  opacity: 1;
}
.chatbot {
  position: fixed;
  right: 35px;
  bottom: 90px;
  width: 410px;
  background: #fff;
  border-radius: 15px;
  overflow: hidden;
  opacity: 0;
  pointer-events: none;
  transform: scale(0.5);
  transform-origin: bottom right;
  box-shadow: 0 0 128px 0 rgba(0,0,0,0.1),
              0 32px 64px -48px rgba(0,0,0,0.5);
  transition: all 0.1s ease;
}
body.show-chatbot .chatbot {
  opacity: 1;
  pointer-events: auto;
  transform: scale(1);
}
.chatbot header {
  padding: 12px 0;
  position: relative;
  text-align: center;
  color: #fff;
  background: #e87e41;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
.chatbot header span {
  position: absolute;
  right: 15px;
  top: 50%;
  display: none;
  cursor: pointer;
  transform: translateY(-50%);
}
header h2 {
  font-size: 1.4rem;
}
.chatbot .chatbox {
  overflow-y: auto;
  height: 450px;
  padding: 30px 20px 100px;
}
.chatbot :where(.chatbox, textarea)::-webkit-scrollbar {
  width: 6px;
}
.chatbot :where(.chatbox, textarea)::-webkit-scrollbar-track {
  background: #fff;
  border-radius: 25px;
}
.chatbot :where(.chatbox, textarea)::-webkit-scrollbar-thumb {
  background: #ccc;
  border-radius: 25px;
}
.chatbox .chat {
  display: flex;
  list-style: none;
}
.chatbox .outgoing {
  margin: 20px 0;
  justify-content: flex-end;
}
.chatbox .incoming span {
  width: 32px;
  height: 32px;
  color: #fff;
  cursor: default;
  text-align: center;
  line-height: 32px;
  align-self: flex-end;
  border-radius: 4px;
  margin: 0 10px 7px 0;
}
.chatbox .chat div {
  /* white-space: pre-wrap; */
  border-radius: 10px 10px 0 10px;
  padding: 12px;
  margin: 0px;
  max-width: 75%;
  color: #fff;
  font-size: 0.95rem;
  background: #e87e41;
}
.chatbox .chat ul {
  margin: 0px 0px 0px 25px;
  padding: 0px;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  /* text-align: justify; */
}
.chatbox .chat ol li {
  margin: 0px;
  padding: 0px;
}
.chatbox .chat p {
  margin: 0px;
  padding: 0px;
}
.chatbox .chat ol {
  margin: 0px 0px 0px 25px;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  /* text-align: justify; */
}
.chatbox .chat div img {
 height: 125px;
 width: 200px;
 margin: 3px;
 border-radius: 5px;
 box-shadow: 5px;
  /* text-align: justify; */
}
.chatbox .incoming div {
  border-radius: 10px 10px 10px 0;

}
.chatbox .incoming ol li {
  margin: 0px;
  padding: 3px;
}
.chatbox .incoming ol {
  padding: 0px;
}
.chatbox .incoming table {
  border-collapse: collapse; /* Ensures no double borders */
  width: 100%; /* Optional: full width of the container */
  margin: 25px 0; /* Optional: spacing around the table */
  font-size: 1em; /* Font size for the table content */
  font-family: Arial, sans-serif; /* Font family for the table content */
  border: 1px solid #ddd; /* Border around the entire table */
}
.chatbox .incoming table th,td {
  border: 1px solid #ddd; /* Border for table cells */
  padding: 12px 15px; /* Padding inside each cell */
  text-align: left; /* Align text to the left */
}
.chatbox .incoming table th {
  background-color: #f2f2f2; /* Background color for header cells */
  font-weight: bold; /* Bold text for headers */
}

.chatbox .incoming table tr:nth-child(even) {
  background-color: #f9f9f9; /* Alternating background color for rows */
}
.chatbox .chat div.error {
  color: #721c24;
  background: #f8d7da;
}
.chatbox .incoming div {
  color: #000;
  background: #f2f2f2;
}
.chatbot .chat-input {
  display: flex;
  gap: 5px;
  position: absolute;
  bottom: 0;
  width: 100%;
  background: #fff;
  padding: 3px 20px;
  border-top: 1px solid #ddd;
}
.chat-input textarea {
  height: 55px;
  width: 100%;
  border: none;
  outline: none;
  resize: none;
  max-height: 180px;
  padding: 15px 15px 15px 0;
  font-size: 0.95rem;
}
.chat-input span {
  align-self: flex-end;
  color: #e87e41;
  cursor: pointer;
  height: 55px;
  display: flex;
  align-items: center;
  visibility: hidden;
  font-size: 1.35rem;
}
.chat-input textarea:valid ~ span {
  visibility: visible;
}

@media (max-width: 490px) {
  .chatbot-toggler {
    right: 20px;
    bottom: 20px;
  }
  .chatbot {
    right: 0;
    bottom: 0;
    height: 100%;
    border-radius: 0;
    width: 100%;
  }
  .chatbot .chatbox {
    height: 90%;
    padding: 25px 15px 100px;
  }
  .chatbot .chat-input {
    padding: 5px 15px;
  }
  .chatbot header span {
    display: block;
  }
  }
#loadingIndicator {
        display: none; /* Ẩn mặc định */
        background-color: #f9f4e6; /* Nền nhẹ để nổi bật */
        color: #c09b5a; /* Màu chữ */
        border: 1px solid #c09b5a; /* Đường viền cùng màu */
        padding: 20px; /* Khoảng cách bên trong */
        border-radius: 5px; /* Bo góc */
        text-align: center; /* Căn giữa nội dung */
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); /* Đổ bóng nhẹ */
        position: fixed; /* Đặt cố định trên màn hình */
        top: 50%; /* Căn giữa theo chiều dọc */
        left: 50%; /* Căn giữa theo chiều ngang */
        transform: translate(-50%, -50%); /* Điều chỉnh vị trí */
        z-index: 1000; /* Đảm bảo hiển thị trên các phần tử khác */
    }
    input[type="date"] {
    background-color: #333; /* Màu nền tùy chỉnh */
    color: white; /* Màu chữ */
    border: 1px solid #d4af37; /* Đường viền */
    border-radius: 5px; /* Bo góc */
    padding: 10px; /* Khoảng cách bên trong */
}

input[type="date"]::-webkit-calendar-picker-indicator {
    background-color: #d4af37; /* Màu cho biểu tượng lịch (chỉ áp dụng cho Chrome) */
    border-radius: 5px;
    padding: 5px; /* Khoảng cách cho biểu tượng */
}
  .total-and-duration {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8f4d9; /* Chỉnh màu nền nếu cần */
            padding: 10px;
            border-radius: 5px; /* Tạo bo góc */
            margin-top: 20px; /* Khoảng cách phía trên */
        }

        .total-amount,
        .stay-duration {
            font-size: 1.2em; /* Tăng kích thước chữ */
            color: #333; /* Màu chữ */
        }

        .total-amount strong,
        .stay-duration strong {
            color: #000; /* Màu chữ đậm */
        }

        .total-amount {
            margin-right: 20px; /* Khoảng cách giữa tổng và số đêm */
        }

        .stay-duration {
            display: flex;
            align-items: center;
        }
       a {
    text-decoration: none; /* Bỏ gạch chân */
    color: #007BFF; /* Màu chữ */
    font-weight: bold; /* Đậm chữ */
  /* Khoảng cách bên trong */
    border: 2px solid transparent; /* Viền trong suốt */
    border-radius: 5px; /* Bo góc */
    transition: background-color 0.3s, border-color 0.3s; /* Hiệu ứng chuyển tiếp */
}


        .booknow:hover{
         background-color: #c09b5a; /* Màu nền khi di chuột */
    color: white;
        }
        
    </style>
</head>
<div th:replace="~{access/nav1 :: html}"></div>

<!-- Date Range Picker -->
<!--   Check-in:
   <input type="date" ng-model="booking.checkin">

   Checkout:
   <input type="date" ng-model="booking.checkout">  -->
<body ng-controller="RoomDetailsController">
<div class="container" style="margin-top: 200px" >
    <h1>ĐẶT PHÒNG</h1>
    <div>
        <div class="row">
            <div class="col-md-6">
                <div class="room-details">
                    <img ng-src="{{roomDetails.img}}" alt="Room Image" class="room-image" />
                    <div class="room-info">
                        <!--            <p><strong>ID ROOM:</strong> {{roomDetails.id}}</p>-->
                        <p><strong>MÃ PHÒNG :</strong> {{roomDetails.roomCode}}</p>
                        <p><strong>SỐ PHÒNG :</strong> {{roomDetails.sophong}}</p>
                        <p><strong>KIỂU PHÒNG :</strong> {{roomDetails.roomType.name}}</p>
                        <p><strong>GIÁ :</strong> ${{roomDetails.gia}}</p>
                       <!--  <p><strong>MÔ TẢ </strong> {{roomDetails.mota}}</p> -->

                    </div>
                </div>
            </div>
            <div class="col-md-6">

                <div class="user-inputs">
                    <!--        <div class="input-group">-->
                    <!--            <label for="userId">Id:</label>-->
                    <!--            <input type="text" id="userId" value="{{user.id}}" class="user-input">-->
                    <!--        </div>-->
                    <div class="input-group">
                        <label for="userName">TÊN </label>
                        <input type="text" id="userName" value="{{user.name}}" class="user-input">
                    </div>
                    <div class="input-group">
                        <label for="checkin">NGÀY NHẬN  </label>
                        <input type="date" id="checkin" ng-model="booking.checkin" ng-change="onDateChange()" class="date-input">
                    </div>
                    <div class="input-group">
                        <label for="checkout">NGÀY TRẢ </label>
                        <input type="date" id="checkout" ng-model="booking.checkout" ng-change="onDateChange()" class="date-input">
                    </div>
                </div>
            </div>
        </div>



<!--//Book-->

        <h2>PHÒNG TRỐNG </h2>
        <div class="row">
            <ul class="available-rooms list-unstyled w-100">
                <div class="row">
                    <li ng-repeat="room in availableRooms" class="room-item col-md-6 mb-4">
                        <div class="room-box d-flex align-items-center">
                       
    <img ng-src="{{room.img}}" class="room-image" alt="Room Image" style="height:210px; width:210px" >
    <div class="room-info d-flex flex-grow-1 align-items-center">
        <p><strong>MÃ PHÒNG:</strong> {{room.roomCode}}</p>
        <p><strong>SỐ PHÒNG:</strong> {{room.sophong}}</p>
        <p><strong>GIÁ:</strong> ${{room.gia}}</p>
        <p><strong>KIỂU PHÒNG:</strong> {{room.roomType.name}}</p>
        <a href="/room/room-details/{{room.id}}">XEM CHI TIẾT</a>
        <label class="booknow" style="margin-left:80px">CLICK ĐẶT NGAY</label>
        <input type="checkbox" class="checkbox ml-3" ng-click="toggleRoomSelection(room)">
    </div>
</div>

                    </li>
                </div>
            </ul>
        </div>


        <div class="user-inputs">
            <div class="input-group">
                <label for="adultCount">NGƯỜI LỚN</label>
                <input type="number" id="adultCount" min="1" max="4" ng-model="booking.adult" class="number-input">
            </div>
            <div class="input-group">
                <label for="childrenCount">TRẺ CON</label>
                <input type="number" id="childrenCount" min="0" max="2" ng-model="booking.children" class="number-input">
            </div>
            <div class="input-group">
                <label for="paymentMethod">PHƯƠNG THỨC THANH TOÁN</label>
                <select id="paymentMethod" ng-model="booking.paymentMethod" class="payment-select">
                    <option value="cash">TIỀN MẶT</option>
                    <option value="transfer">CHUYỂN KHOẢN</option>
                </select>
            </div>
        </div>

        <!--    <p><strong>Total:</strong> ${{ total }}</p>-->
       <div class="total-and-duration">
    <p class="total-amount"><strong>TỔNG </strong> {{ totalAmount }} VND</p>
    <div class="stay-duration">
        <p><strong>SỐ ĐÊM </strong> {{stayDuration}} ĐÊM</p>
    </div>
</div>

        <button ng-click="bookRoom()" class="book-button">Book</button>
		<div id="loadingIndicator" style="display: none;">
    <p>Đang xử lý, vui lòng đợi...</p>
    <p>Chúng tôi đang gửi mail thông tin đặt phòng cho bạn</p>
    <!-- You can add a spinner or any other visual indicator here -->
</div>
        <!-- List of Booked Dates -->
        <h2>LỊCH ĐÃ ĐẶT TRƯỚC </h2>
        <div class="row">
            <div class="col-md-4">
                <ul class="booked-dates">
                    <li ng-repeat="booking in bookedDates | filter: isFutureCheckout" ng-if="$index % 3 === 0">
                        NGÀY NHẬN PHÒNG: {{booking.checkin | date:'dd-MM-yyyy'}} <br>
                        NGÀY TRẢ PHÒNG: {{booking.checkout | date:'dd-MM-yyyy'}}
                    </li>
                </ul>
            </div>
            <div class="col-md-4">
                <ul class="booked-dates">
                    <li ng-repeat="booking in bookedDates | filter: isFutureCheckout" ng-if="$index % 3 === 1">
                        NGÀY NHẬN PHÒNG: {{booking.checkin | date:'dd-MM-yyyy'}} <br>
                        NGÀY TRẢ PHÒNG: {{booking.checkout | date:'dd-MM-yyyy'}}
                    </li>
                </ul>
            </div>
            <div class="col-md-4">
                <ul class="booked-dates">
                    <li ng-repeat="booking in bookedDates | filter: isFutureCheckout" ng-if="$index % 3 === 2">
                        NGÀY NHẬN PHÒNG: {{booking.checkin | date:'dd-MM-yyyy'}} <br>
                        NGÀY TRẢ PHÒNG: {{booking.checkout | date:'dd-MM-yyyy'}}
                    </li>
                </ul>
            </div>
        </div>

    </div>
    
    
</div>
<script>

    angular.module('app', [])
        .controller('RoomDetailsController', ['$scope', '$http', '$window', function($scope, $http, $window) {
            $scope.roomDetails = {}; // Initialize empty object for room details
            $scope.booking = { paymentMethod: 'cash' }; // Initialize with default payment method
            // $scope.booking = { paymentMethod: 'cash', adult: 1, children: 0 };
            $scope.user = {};
            $scope.bookedDates = [];
            $scope.availableRooms = [];
            $scope.totalAmount = 0;
            $scope.availableRooms = [];
            $scope.selectedRooms = [];
            // Get the room ID from the current URL
            const roomId = $window.location.pathname.split('/').pop(); // Gets the last part of the URL
            const apiUrl = `/api/get-room-details?roomId=${roomId}`;
            $scope.onDateChange = function() {
                $scope.loadAvailableRooms(); // Load available rooms based on selected dates
                $scope.calculateTotalAmount();
                $scope.calculateStayDuration();// C alculate the total amount based on selected dates
            };
            // Fetch room details from API


            $http({
                method: 'GET',
                url: '/api/user-info'
            }).then(function successCallback(response) {
                $scope.user = response.data; // Assign API data to scope
            }, function errorCallback(response) {
                console.error('Error fetching user info:', response);
            });

            /*   $scope.bookRoom = function() {
                  const bookings = $scope.selectedRooms.map(room => ({
                      Userid: $scope.user.id,
                      roomid: room.id,
                      price: room.gia,
                      checkin: $scope.booking.checkin,
                      checkout: $scope.booking.checkout,
                      adult: $scope.booking.adult,
                      children: $scope.booking.children,
                      paymentMethod: $scope.booking.paymentMethod
                  }));

                  if (bookings.length === 0) {
                      alert("No valid rooms to book.");
                      return;
                  }

                  bookings.forEach(bookingData => {
                      console.log("Sending booking data:", JSON.stringify(bookingData));
                      $http.post('http://localhost:8081/api/book-room', bookingData, {
                          headers: { 'Content-Type': 'application/json' }
                      })
                      .then(response => {
                          console.log('Booking successful:', response.data);
                          alert(response.data);
                          $scope.loadBookedDates(); // Load booked dates
                      })
                      .catch(error => {
                          console.error('Error booking room:', error);
                          const errorMessage = error.data && error.data.error ? error.data.error : "An unknown error occurred.";
                          alert("Error booking room: " + errorMessage);
                      });
                  });
              }; */

            $http({
                method: 'GET',
                url: apiUrl
            }).then(function successCallback(response) {
                $scope.roomDetails = response.data; // Assign API data to scope
            }, function errorCallback(response) {
                console.error('Error fetching room details:', response);
            });

            $scope.calculateTotalAmount = function() {
                if ($scope.booking.checkin && $scope.booking.checkout) {
                    const checkinDate = new Date($scope.booking.checkin);
                    const checkoutDate = new Date($scope.booking.checkout);
                    const daysBetween = (checkoutDate - checkinDate) / (1000 * 3600 * 24);

                    if (daysBetween > 0 && $scope.selectedRooms.length > 0) {
                        // Calculate total based on selected rooms
                        $scope.totalAmount = $scope.selectedRooms.reduce((total, room) => {
                            return total + (daysBetween * room.gia);
                        }, 0);
                    } else {
                        $scope.totalAmount = 0; // No rooms selected or invalid dates
                    }
                } else {
                    $scope.totalAmount = 0; // No check-in or check-out dates
                }
            };

            $scope.toggleRoomSelection = function(room) {
                const index = $scope.selectedRooms.findIndex(selectedRoom => selectedRoom.id === room.id);
                const checkinDate = new Date($scope.booking.checkin);
                const checkoutDate = new Date($scope.booking.checkout);
                const daysBetween = (checkoutDate - checkinDate) / (1000 * 3600 * 24);

                if (daysBetween > 0) {
                    if (index === -1) {
                        $scope.selectedRooms.push(room); // Add the room if not already selected
                    } else {
                        $scope.selectedRooms.splice(index, 1); // Remove if already selected
                    }
                }

                $scope.calculateTotalAmount(); // Recalculate the total after selecting or deselecting
            };
            /*   $scope.toggleRoomSelection = function(room) {
                  const index = $scope.selectedRooms.indexOf(room);
                  if (index > -1) {
                      $scope.selectedRooms.splice(index, 1);
                  } else {
                      $scope.selectedRooms.push(room);
                  }
              }; */
            $scope.loadAvailableRooms = function() {
                if ($scope.booking.checkin && $scope.booking.checkout) {
                    const checkin = new Date($scope.booking.checkin).toISOString().slice(0, 10);
                    const  checkout = new Date($scope.booking.checkout).toISOString().slice(0, 10);

                    $http({
                        method: 'GET',
                        url: `/api/get-available-rooms?checkin=${checkin}&checkout=${checkout}&status=TRUE`
                    }).then(function successCallback(response) {
                        console.log("Available rooms:", response.data);
                        $scope.availableRooms = response.data;
                    }, function errorCallback(response) {
                        console.error('Error fetching available rooms:', response);
                    });
                }
            };

            $scope.loadBookedDates = function() {
                $http({
                    method: 'GET',
                    url: `/api/get-bookings?roomId=${roomId}`
                }).then(function successCallback(response) {
                    $scope.bookedDates = response.data; // Assign booked dates to scope
                    /* $scope.bookedDates.sort(function(a, b) {
                        // Compare check-in dates
                        return new Date(a.checkin) - new Date(b.checkin);
                    }); */
                }, function errorCallback(response) {
                    console.error('Error fetching booked dates:', response.status, response.data);
                });
            };


            $scope.validateBookingDates = function(checkin, checkout) {
                const today = new Date();
                const todayStart = new Date(today.setHours(0, 0, 0, 0)); // Ngày hiện tại, đặt giờ phút giây về 0
                const checkinDate = new Date(checkin);
                const checkoutDate = new Date(checkout);

                // Check nếu ngày vào hoặc ngày ra trong quá khứ
                if (checkinDate < todayStart || checkoutDate < todayStart) {
                    alert("Ngày đặt không được đặt trong quá khứ.");
                    return false;
                }
                // Kiểm tra nếu ngày ra nhỏ hơn hoặc bằng ngày vào
                if (checkoutDate <= checkinDate) {
                    alert("Ngày ra không được nhỏ hơn hoặc bằng ngày vào.");
                    return false;
                }

                // Kiểm tra số lượng người
                const adults = $scope.booking.adult || 0;
                const children = $scope.booking.children || 0;
                if (adults + children <= 0) {
                    alert("Số lượng người không được bằng 0.");
                    return false;
                }

                // Check trùng lặp ngày đặt với các đặt phòng đã tồn tại
                for (let booking of $scope.bookedDates) {
                    const bookedCheckin = new Date(booking.checkin);
                    const bookedCheckout = new Date(booking.checkout);

                    if ((checkinDate >= bookedCheckin && checkinDate < bookedCheckout) ||
                        (checkoutDate > bookedCheckin && checkoutDate <= bookedCheckout) ||
                        (checkinDate <= bookedCheckin && checkoutDate >= bookedCheckout)) {

                        alert(`Các ngày đã chọn bị trùng với một đặt phòng hiện có.\nĐặt phòng trùng lắp:\nNhận phòng: ${booking.checkin}, Trả phòng: ${booking.checkout}`);
                        return false;
                    }
                }

                return true;
            };


            // Function to book room
            $scope.bookRoom = function() {
                // Validate booking dates
                document.getElementById("loadingIndicator").style.display = "block";

    // Validate booking dates
    if (!$scope.validateBookingDates($scope.booking.checkin, $scope.booking.checkout)) {
        document.getElementById("loadingIndicator").style.display = "none"; // Hide loading if validation fails
        return;
    }

                // Check if any rooms are selected
                if ($scope.selectedRooms.length === 0) {
                    alert('Hãy chọn ít nhất phòng muốn đặt.');
                    return; // Exit the function if no rooms are selected
                }

                const checkinDate = new Date(Date.UTC(
                    $scope.booking.checkin.getFullYear(),
                    $scope.booking.checkin.getMonth(),
                    $scope.booking.checkin.getDate()
                ));

                const checkoutDate = new Date(Date.UTC(
                    $scope.booking.checkout.getFullYear(),
                    $scope.booking.checkout.getMonth(),
                    $scope.booking.checkout.getDate()
                ));

                const bookingData = {
                    Userid: $scope.user.id,
                    roomid: $scope.selectedRooms.map(room => room.id), // Get selected room IDs
                    price: $scope.roomDetails.gia,
                    checkin: checkinDate.toISOString().split('T')[0],
                    checkout: checkoutDate.toISOString().split('T')[0],
                    adult: $scope.booking.adult,
                    children: $scope.booking.children,
                    paymentMethod: $scope.booking.paymentMethod
                };

                // Calculate total amount
                const timeDifference = checkoutDate.getTime() - checkinDate.getTime();
                const daysBetween = timeDifference / (1000 * 3600 * 24);
                if (daysBetween > 7) {
                    alert("Khoảng thời gian đặt phòng không được vượt quá 7 ngày.");
                    $scope.totalAmount = 0;
                    document.getElementById("loadingIndicator").style.display = "none"; // Ẩn loading
                    return; // Thoát khỏi hàm
                }
                const totalAmount = daysBetween * $scope.roomDetails.gia; // This can be adjusted based on selected rooms
                $scope.totalAmount = totalAmount;

                // Proceed with booking based on payment method
                if (bookingData.paymentMethod === 'cash') {
                    // Save booking directly for cash payments
                    bookingData.paymentStatus = 'notpayment';
                    bookingData.bookDetailStatus = 'notcheckin';
                    $http({
                        method: 'POST',
                        url: '/api/book-room',
                        data: bookingData,
                        transformResponse: [function (data) {
                            return data; // Handle the response as text
                        }]
                    }).then(function successCallback(response) {
                        console.log('Booking successful:', response.data);
                        alert(response.data);
                        $window.location.href ="/account/info";
                        $scope.loadBookedDates();

                    }, function errorCallback(response) {
                        console.error('Error booking room:', response);
                        alert('Error booking room: ' + response.data);
                    });
                } else if (bookingData.paymentMethod === 'transfer') {
                    // Save booking details in the database for bank transfer
                    bookingData.paymentStatus = 'notpayment';
                    bookingData.bookDetailStatus = 'notcheckin';
                    $http({
                        method: 'POST',
                        url: '/payment/book-room',
                        data: bookingData,
                        transformResponse: [function (data) {
                            return data; // Handle the response
                        }]
                    }).then(function successCallback(response) {
                        console.log('Booking successful:', response.data);
                        alert(response.data);
                        $window.location.href = `/${response.data}`;
                        /*  const paymentUrl = `/pay?total=${totalAmount}`;
                         $window.location.href = paymentUrl; */

                        $scope.loadBookedDates();
                    }, function errorCallback(response) {
                        console.error('Error booking room:', response);
                        alert('Error booking room: ' + response.data);
                    }).finally(function() {
                        document.getElementById("loadingIndicator").style.display = "none"; // Ẩn loading sau khi hoàn tất
                    });
                }
            };

            function checkPaymentStatus(bookingId) {
                // Giả sử bạn sử dụng setInterval để kiểm tra trạng thái
                const interval = setInterval(() => {
                    $http.get(`/api/check-payment-status/${bookingId}`)
                        .then(function(statusResponse) {
                            if (statusResponse.data.status === 'success') {
                                // Cập nhật trạng thái thanh toán thành công
                                updatePaymentStatus(bookingId, 'successfully');
                                clearInterval(interval); // Dừng kiểm tra
                            }
                        })
                        .catch(function(error) {
                            console.error('Error checking payment status:', error);
                        });
                }, 5000); // Kiểm tra mỗi 5 giây
            }

            // Hàm cập nhật trạng thái thanh toán
            function updatePaymentStatus(bookingId, status) {
                $http.put(`/api/update-payment-status/${bookingId}`, { paymentStatus: status })
                    .then(function(updateResponse) {
                        console.log('Payment status updated:', updateResponse.data);
                    })
                    .catch(function(error) {
                        console.error('Error updating payment status:', error);
                    });
            }
            $scope.isFutureCheckout = function(booking) {
                var now = new Date();
                var checkoutDate = new Date(booking.checkout);
                return booking.bookDetailStatus !== 'cancel' && checkoutDate > now;
            };

            $scope.loadBookedDates();

            $scope.calculateStayDuration = function() {
                if ($scope.booking.checkin && $scope.booking.checkout) {
                    const checkinDate = new Date($scope.booking.checkin);
                    const checkoutDate = new Date($scope.booking.checkout);
                    const daysBetween = (checkoutDate - checkinDate) / (1000 * 3600 * 24);

                    // Nếu số ngày lớn hơn 0, cập nhật giá trị stayDuration
                    if (daysBetween > 0) {
                        $scope.stayDuration = daysBetween;
                    } else {
                        $scope.stayDuration = 0; // Nếu ngày không hợp lệ
                    }
                } else {
                    $scope.stayDuration = 0; // Không có ngày checkin hoặc checkout
                }
            };
        }]);

</script>


</body>
</html>